<?php

//implementation of hook_permission
function itonics_nirala_faculty_permission()
{
  return [
    'view itonics nirala faculty' => [
      'title' => t('View Faculty'),
      'description' => t('Access to view faculty details.'),
    ],
    'add itonics nirala faculty' => [
      'title' => t('Add Faculty'),
      'description' => t('Access to add faculty details.'),
    ],
    'edit itonics nirala faculty' => [
      'title' => t('Edit Faculty'),
      'description' => t('Access to edit faculty details.'),
    ],
    'delete itonics nirala faculty' => [
      'title' => t('Delete Faculty'),
      'description' => t('Access to delete faculty details.'),
    ],
  ];
}

//implementation of hook_menu
function itonics_nirala_faculty_menu()
{
  $items = array();

  // Faculty List Page
  $items['admin/itonics_faculty'] = array(
    'title' => 'Manage Faculty',
    'page callback' => 'itonics_nirala_faculty_page',
    'access callback' => 'user_access',
    'access arguments' => array('view itonics nirala faculty'),
    'type' => MENU_NORMAL_ITEM,
  );

  // Add Faculty Form
  $items['admin/itonics_faculty/add'] = array(
    'title' => 'Add Faculty',
    'page callback' => 'itonics_nirala_faculty_create_form_load',
    'page arguments' => array(),
    'access callback' => 'user_access',
    'access arguments' => array('add itonics nirala faculty'),
    'type' => MENU_CALLBACK,
  );

  // edit Faculty Form
  $items['admin/itonics_faculty/edit/%'] = array(
    'title' => 'Edit Faculty',
    'page callback' => 'itonics_nirala_faculty_edit_form_load',
    'page arguments' => [3],
    'access callback' => 'user_access',
    'access arguments' => array('edit itonics nirala faculty'),
    'type' => MENU_CALLBACK,
  );

  $items['admin/itonics_faculty/delete/%'] = [
    'title' => t('Delete Faculty'),
    'page callback' => 'nirala_itonics_faculty_delete_page',
    'page arguments' => [3],
    'access callback' => 'user_access',
    'access arguments' => ['delete itonics nirala faculty'],
    'type' => MENU_CALLBACK,
  ];

  return $items;
}

function itonics_nirala_faculty_page()
{
  ctools_include('ajax');
  ctools_include('modal');
  ctools_modal_add_js();

  $header = array(
    array('data' => 'Faculty ID', 'field' => 'id'),
    array('data' => 'Faculty Name', 'field' => 'name'),
    array('data' => 'Operations'),
  );

  // Add Faculty Button (Top-Right Styling)
  $add_btn = '<div style="text-align: right; margin-bottom: 10px;">' .
    ctools_modal_text_button(
      t('Add Faculty'),
      'admin/itonics_faculty/add',
      t('Add Faculty via Modal'),
      'ctools-modal-modal-popup-small'
    ) .
    '</div>';

  // Fetch faculty records
  $query = db_select('itonics_nirala_faculty', 'f')
    ->fields('f', ['id', 'name', 'status'])
    ->addTag('faculty_query')
    ->addMetadata('caller', 'faculty_list_page') // Add metadata for debugging
    ->execute();

  // Prepare the rows for the table
  $rows = [];
  foreach ($query as $faculty) {
    $links = [];

    // Create the edit and delete buttons for each faculty


    $links[] = ctools_modal_text_button(t('Edit Faculty'), 'admin/itonics_faculty/edit/'  . $faculty->id, t('Edit Faculty via Modal'),  'ctools-modal-modal-popup-small');
    $links[] = ctools_modal_text_button(
      t('Delete Faculty'),
      'admin/itonics_faculty/delete/' . $faculty->id,
      t('Delete Faculty via Modal'),
      'ctools-modal-modal-popup-small'
    );

    // Add the faculty data row
    $rows[] = [
      'data' => [
        $faculty->id,
        check_plain($faculty->name),
        implode(' | ', $links),
      ],
    ];
  }

  // module invoking the teachers list
  $teacherdata = module_invoke('itonics_nirala_teacher', 'list_page');

  // Optionally: Prepare the table header
  $header = [
    t('ID'),
    t('Name'),
    t('Actions'),
  ];

  // Combine student data and table output
  return $add_btn . theme('table', ['header' => $header, 'rows' => $rows]) . '<div style="margin-top: 20px;">' . $teacherdata . '</div>';
}


function itonics_nirala_faculty_create_form_load()
{

  ctools_include('ajax');
  ctools_include('modal');
  ctools_modal_add_js();
  $form = drupal_get_form('itonics_nirala_faculty_form');
  $commands[] = ctools_modal_command_display("Create Faculty", $form);
  print ajax_render($commands);
  exit;
}

function itonics_nirala_faculty_edit_form_load($id)
{
  ctools_include('ajax');
  ctools_include('modal');
  ctools_modal_add_js();

  $faculty = db_select('itonics_nirala_faculty', 'f')
    ->fields('f')
    ->condition('id', $id)
    ->execute()
    ->fetchAssoc();

  if (!$faculty) {
    drupal_set_message(t('Faculty not found.'), 'error');
    return;
  }

  // Pass faculty data to the form
  $form = drupal_get_form('itonics_nirala_faculty_form', $faculty);
  $commands[] = ctools_modal_command_display("Edit Faculty", $form);

  print ajax_render($commands);
  exit;
}



function itonics_nirala_faculty_form($form, &$form_state, $faculty = array())
{
  ctools_include('ajax');
  ctools_include('modal');
  ctools_modal_add_js();

  $form['id'] = array(
    '#type' => 'hidden',
    '#value' => isset($faculty['id']) ? $faculty['id'] : '',
  );

  $form['name'] = [
    '#type' => 'textfield',
    '#title' => t('Name'),
    '#default_value' => isset($faculty['name']) ? check_plain($faculty['name']) : '',
    '#required' => TRUE,
  ];

  $form['actions']['submit'] = [
    '#type' => 'submit',
    '#value' => isset($faculty['id']) ? t('Update Faculty') : t('Add Faculty'),
    '#ajax' => [
      'callback' => 'itonics_nirala_faculty_form_submit',
      'wrapper' => 'faculty-list-wrapper',
    ],
  ];

  if ($form_state['submitted']) {
    $commands[] = ctools_modal_command_dismiss();
    $commands[] = ctools_ajax_command_redirect('admin/itonics_faculty');
    print ajax_render($commands);
    exit;
  }
 
  return $form;
}


function itonics_nirala_faculty_form_submit($form, &$form_state)
{
  $values = [
    'name' => $form_state['values']['name'],
  ];

  if (!empty($form_state['values']['id'])) {
    itonics_nirala_faculty_update($form_state['values']['id'], $values);
    $message = 'Faculty updated successfully.';
    $operation = 'update';
  } else {
    itonics_nirala_faculty_create($values);
    $message = 'Faculty created successfully.';
    $operation = 'insert';
  }

  // Allow other modules to alter the message before displaying/logging
  drupal_alter('faculty_message', $message, $values, $operation);

  // Set the message on the UI
  drupal_set_message($message);

  // Log the altered message in watchdog
  watchdog('itonics_nirala_faculty', $message, [], WATCHDOG_NOTICE);

  $form_state['rebuild'] = TRUE;
  $form_state['redirect'] = 'admin/itonics_faculty';
}

function itonics_nirala_faculty_update($id, $values)
{
  return db_update('itonics_nirala_faculty')
    ->fields($values)
    ->condition('id', $id)
    ->execute();
}

function itonics_nirala_faculty_create($values)
{
  return db_insert('itonics_nirala_faculty')
    ->fields($values)
    ->execute();
}


function nirala_itonics_faculty_delete_page($id)
{
  ctools_include('ajax');
  ctools_include('modal');
  ctools_modal_add_js();

  // Fetch Faculty Data
  $faculty = db_select('itonics_nirala_faculty', 'p')
    ->fields('p')
    ->condition('id', $id)
    ->execute()
    ->fetchAssoc();

  if (!$faculty) {
    drupal_set_message(t('Faculty not found.'), 'error');
    return drupal_goto('admin/itonics_faculty');
  }

  $form = drupal_get_form('nirala_itonics_faculty_delete_form', $faculty);
  $commands[] = ctools_modal_command_display("Delete Faculty", $form);

  print ajax_render($commands);
}

function nirala_itonics_faculty_delete_form($form, &$form_state, $faculty)
{
  $form['id'] = [
    '#type' => 'hidden',
    '#value' => $faculty['id'],
  ];
  $form = confirm_form($form,
    'Are you sure, Do you want to delete?',
    'activity-list',
    'The action cannot be undone.',
    'Delete',
    'Cancel',
  );
  return $form;
}

function nirala_itonics_faculty_delete_form_submit($form, &$form_state)
{
  ctools_include('ajax');
  ctools_include('modal');
  ctools_modal_add_js();

  $id = $form_state['values']['id'];

  // Delete Faculty
  db_delete('itonics_nirala_faculty')
    ->condition('id', $id)
    ->execute();

  if ($form_state['submitted']) {
    $commands[] = ctools_modal_command_dismiss();
    $commands[] = ctools_ajax_command_redirect('admin/itonics_faculty');
    print ajax_render($commands);
    exit;
  }
}

//implementation of hook_form_alter
function itonics_nirala_faculty_form_alter(&$form, &$form_state, $form_id)
{
  $id = arg(3);
  $table = ($form_id == "itonics_nirala_student_form") ? 'itonics_nirala_student' : 'itonics_nirala_teacher';

  if ($form_id == "itonics_nirala_student_form" || $form_id == "itonics_nirala_teacher_form") {
    // Fetch faculty data
    $faculty = db_select('itonics_nirala_faculty', 's')
      ->fields('s', ['id', 'name'])
      ->execute()
      ->fetchAllKeyed();

    $faculty_id = NULL;

    if (!empty($id) && is_numeric($id)) {
      $faculty_id = db_select($table, 't')
        ->fields('t', ['faculty_id'])
        ->condition('t.id', $id, '=')
        ->execute()
        ->fetchField();
    }

    $form['faculty_id'] = [
      '#type' => 'select',
      '#title' => t('Faculty'),
      '#options' => ['' => t('- Select Faculty -')] + $faculty,
      '#required' => FALSE,
      '#weight' => 8,
      '#default_value' => isset($faculty_id) ? filter_xss($faculty_id) : '',
    ];
  }
}



function itonics_nirala_faculty_schema_alter(&$schema)
{
  // Add field to existing schema.
  $schema['itonics_nirala_student']['fields']['timezone_id'] = array(
    'type' => 'int',
    'not null' => TRUE,
    'default' => 0,
    'description' => 'Test field.',
  );
}

/**
 * Implements hook_query_alter().
 */
function itonics_nirala_faculty_query_alter($query)
{
  if ($query->hasTag('faculty_query')) {
    $query->condition('status', '1');

    $query->addMetadata('debug', 'Faculty query altered to include only active records');
  }
}
